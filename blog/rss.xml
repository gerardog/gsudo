<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>gsudo (sudo for windows) Blog</title>
        <link>https://gerardog.github.io/gsudo/blog</link>
        <description>gsudo (sudo for windows) Blog</description>
        <lastBuildDate>Sun, 21 Aug 2022 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Migrating gsudo to .NET 7]]></title>
            <link>https://gerardog.github.io/gsudo/blog/gsudo-dotnet-7</link>
            <guid>gsudo-dotnet-7</guid>
            <pubDate>Sun, 21 Aug 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[The first gsudo versions were made in 2019, around the release of .NET Core 3. I tried to figure out how .NET Core's redistribution model worked, but it didn't worked for me. One should either redistribute the full runtime, or ask the user to manually download and install it. There was another option: to build a self-cointained app (with runtime embedded) but that increased the output size by more than 80mb!]]></description>
            <content:encoded><![CDATA[<p>The first gsudo versions were made in 2019, around the release of .NET Core 3. I tried to figure out how .NET Core's redistribution model worked, but it didn't worked for me. One should either redistribute the full runtime, or ask the user to manually download and install it. There was another option: to build a self-cointained app (with runtime embedded) but that increased the output size by more than 80mb!</p><p>The alternative was to target .NET Framework v4.6. This version is bundled with every Windows 10/11. When targeting it, gsudo build output size was around 100kb. The app on v4.6 loaded faster, so targeting v4.6 seemed logical. It was small, fast, and the installation didn't required any big runtime redistribution or additional steps.</p><p>Recently, things have changed a little with <a href="https://devblogs.microsoft.com/dotnet/announcing-dotnet-7-preview-3/#faster-lighter-apps-with-native-aot" target="_blank" rel="noopener noreferrer">.NET 7 Preview 3 announcement</a> and NativeAOT: "Publishing your app as native AOT produces an app that is self-contained and that has been ahead-of-time (AOT) compiled to native code. Native AOT apps start up very quickly and use less memory. Users of the application can run it on a machine that doesn't have the .NET runtime installed."</p><p>I'm almost sold! Let's try it out... <em>(sounds of frenetic typing)</em>... Ok, that was <a href="https://github.com/gerardog/gsudo/compare/971ea97c...7c0c1b71" target="_blank" rel="noopener noreferrer">18 files changed</a>. Now I have a multi-target project that can compile for v4.6 or v7. Not bad. </p><p>But not everyone's cup of tea: NativeAOT builds for each specific platform, so instead of having one AnyCPU build, now I have two (x64 and x86). But also, NativeAOT is only supported on x64. The closest for x86 is a self-contained build with Ready2Run.</p><p>Let's do some test the performance. So first let´s build for each platform:</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Build .NET Framework v4.6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">msbuild </span><span class="token operator">/</span><span class="token plain">t:Restore </span><span class="token operator">/</span><span class="token plain">p:RestorePackagesConfig=true src\gsudo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sln </span><span class="token operator">/</span><span class="token plain">v:Minimal </span><span class="token operator">/</span><span class="token plain">p:TargetFrameworkVersion=v4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">msbuild </span><span class="token operator">/</span><span class="token plain">t:Rebuild </span><span class="token operator">/</span><span class="token plain">p:Configuration=Release src\gsudo\gsudo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">csproj </span><span class="token operator">/</span><span class="token plain">v:Minimal </span><span class="token operator">/</span><span class="token plain">p:WarningLevel=0 </span><span class="token operator">/</span><span class="token plain">p:TargetFrameworkVersion=v4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">6</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Build .NET 7.0 x64 build with NativeAOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">dotnet clean </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\src\gsudo\gsudo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">csproj </span><span class="token operator">-</span><span class="token plain">f net7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">0 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">dotnet publish </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\src\gsudo\gsudo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">csproj </span><span class="token operator">-</span><span class="token plain">c Release </span><span class="token operator">-</span><span class="token plain">f net7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">0 </span><span class="token operator">-</span><span class="token plain">r win-x64 </span><span class="token operator">--</span><span class="token function" style="color:rgb(80, 250, 123)">sc</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">p:PublishAot=true </span><span class="token operator">-</span><span class="token plain">p:IlcOptimizationPreference=Size </span><span class="token operator">-</span><span class="token plain">v minimal </span><span class="token operator">-</span><span class="token plain">p:WarningLevel=0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Build .NET 7.0 x86 build with Ready2Run</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">dotnet clean </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\src\gsudo\gsudo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">csproj </span><span class="token operator">-</span><span class="token plain">f net7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">0 </span><span class="token operator">-</span><span class="token plain">r win-x86 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Out-null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">dotnet publish </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">\src\gsudo\gsudo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">csproj </span><span class="token operator">-</span><span class="token plain">c Release </span><span class="token operator">-</span><span class="token plain">f net7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">0 </span><span class="token operator">-</span><span class="token plain">r win-x86 </span><span class="token operator">--</span><span class="token function" style="color:rgb(80, 250, 123)">sc</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">p:PublishReadyToRun=true </span><span class="token operator">-</span><span class="token plain">p:PublishSingleFile=true </span><span class="token operator">-</span><span class="token plain">v minimal </span><span class="token operator">-</span><span class="token plain">p:WarningLevel=0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let´s meassure 100 elevations using a preexisting credentials cache. I am using <code>gsudo -d</code> to force an elevation using <code>cmd.exe</code>, which loads much faster and predictable than <code>Powershell</code>. Then I repeated the tests with each different build.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$gsudo</span><span class="token plain">=</span><span class="token string" style="color:rgb(255, 121, 198)">"C:\git\gsudo\src\gsudo\bin\net46\gsudo.exe"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&amp; </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$gsudo</span><span class="token plain"> cache on </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">out-null</span><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># start a cache session.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&amp; </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$gsudo</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">d </span><span class="token function" style="color:rgb(80, 250, 123)">dir</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">out-null</span><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># test the cache session.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">Measure-Command</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> 1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">100 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token operator">%</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> &amp; </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$gsudo</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">d </span><span class="token function" style="color:rgb(80, 250, 123)">dir</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">select</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">Property TotalSeconds </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Format-List</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&amp; </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$gsudo</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">k </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">out-null</span><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># close cache.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The first results were absurd. I found out Windows Defender takes extra time to verify unsigned apps in the cloud. So I disabled Defender and started over.</p><table><thead><tr><th></th><th>v1.3.0 (Net 4.6 + ilmerge + CodeSigned)</th><th>Latest (Net 4.6 unsigned)</th><th>Net 7.0 x64 NativeAOT (unsigned)</th><th>Net 7.0 x86 Ready2Run (unsigned)</th></tr></thead><tbody><tr><td>Size</td><td>180.5 KB</td><td>208.5 KB</td><td>6.17 MB</td><td>16.89 MB</td></tr><tr><td>Time to elevate 100 times (sum)</td><td>12.75 s</td><td>12.62 s</td><td>7.83 s</td><td>10.94 s</td></tr><tr><td>Performance improvement</td><td>(baseline)</td><td>1.04%</td><td>38.62%</td><td>14.18%</td></tr></tbody></table><p>Wow! An improvement of 38.62% is significant enough to ignore the fact that the file size has increased 6 MB, or almost 30 times. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="should-gsudo-target-net-70">Should gsudo target .NET 7.0?<a class="hash-link" href="#should-gsudo-target-net-70" title="Direct link to heading">​</a></h2><p>The problem is that the installer should provide for all platforms, and so far I´ve only focused on x64. What options do I have?</p><ul><li>I could fall back to Net 4.6 (targeting AnyCPU) for the remaining platforms. The down-side would be different prerequisites for each scenario. But the installer would only grow 6mb.</li><li>Or include x86 Net 7.0 Read2Run version. It´s faster, but takes 16mb. The setup including both would  take 23 MB (actually 10mb when compressed)!  </li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="current-situation">Current situation<a class="hash-link" href="#current-situation" title="Direct link to heading">​</a></h2><p>Right now my code-signing certificate is expired. Once I´ve got a new certificate, I will be making a test release. I will update this post then.</p>]]></content:encoded>
        </item>
    </channel>
</rss>